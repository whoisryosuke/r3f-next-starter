!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Loader={})}(this,(function(e){"use strict";const t={id:{size:1,default:!0},position:{size:3,default:!0},charUv:{size:2,default:!0},uv:{size:2,default:!1},normal:{size:3,default:!1},charPosition:{size:3,default:!1},lineIndex:{size:1,default:!1},charIndex:{size:1,default:!1},charSize:{size:2,default:!1},wordIndex:{size:1,default:!1},lineCharIndex:{size:1,default:!1},lineWordIndex:{size:1,default:!1},lineWordCount:{size:1,default:!1},lineCharCount:{size:1,default:!1}};class i{pages;chars;indexedChar={};info;common;distanceField;kernings;constructor(e){this.pages=e.pages,this.chars=e.chars,this.common=e.common,this.info=e.info,this.common=e.common,this.distanceField=e.distanceField,this.kernings=e.kernings,"msdf"!==this.distanceField.fieldType&&console.warn('three-msdf-text(font.distanceField): fieldType should be "msdf"'),e.chars.forEach((e=>this.indexedChar[e.char]=e))}}function n(e,t,i){for(let n=0;n<e.kernings.length;n++){const s=e.kernings[n];if(!(s.first<t)&&!(s.second<i))return s.first>t||s.first===t&&s.second>i?0:s.amount}return 0}const s=/\n/,r=/\s/,o=/\t/;class h{font;text;width;height;alignX;alignY;_size;letterSpacing;tabSize;lineHeight;wordSpacing;wordBreak;lineBreak;textScale;lines;computedWidth;computedHeight;lineCount;constructor({font:e,text:t,width:n="auto",height:s="auto",alignX:r="left",alignY:o="top",size:h=1,letterSpacing:a=0,tabSize:d=4,lineHeight:l=1,wordSpacing:u=0,wordBreak:c=!1,lineBreak:f=!0}={}){this.font=e instanceof i?e:new i(e),this.text=t,this.width=n,this.height=s,this.alignX=r,this.alignY=o,this.size=h,this.letterSpacing=a,this.tabSize=d,this.lineHeight=l,this.wordSpacing=u,this.wordBreak=c,this.lineBreak=f,this.compute()}get size(){return this._size}set size(e){this._size=e,this.textScale=this._size/(this.font.common.lineHeight||this.font.common.baseline||this.font.common.base)}compute(){this.lines=[];let e=0,t=0,i=0;const h=()=>{const n={index:this.lines.length,width:0,chars:[]};return this.lines.push(n),t=e,i=0,n};let a=h(),d=0;for(;e<this.text.length&&d<100;){const l=this.text[e];let u=0;if(d++,s.test(l)){e++,a=h();continue}if(!a.width&&r.test(l)&&!o.test(l)){e++,t=e,i=0;continue}const c=this.font.indexedChar[l]||this.font.indexedChar[" "];if(!c)throw new Error(`Missing glyph "${l}"`);if(a.chars.length&&c){const e=a.chars[a.chars.length-1].definition,t=n(this.font,c.id||0,e.id)*this.textScale;a.width+=t,i+=t}if(a.chars.push({definition:c,x:a.width,y:0,lineIndex:a.index,lineCharIndex:a.chars.length}),o.test(l)?(t=e,i=0,u+=this.font.indexedChar.o.width*this.textScale*this.tabSize):r.test(l)?(t=e,i=0,u+=this.wordSpacing*this.size):u+=this.letterSpacing*this.size,u+=c.xadvance*this.textScale,a.width+=u,i+=u,"auto"!==this.width&&a.width>this.width&&this.lineBreak){if(this.wordBreak&&a.chars.length>1){a.width-=u,a.chars.pop(),a=h();continue}if(!this.wordBreak&&i!==a.width){const n=e-t+1;a.chars.splice(-n,n),e=t,a.width-=i,a=h();continue}}e++,d=0}a.width||this.lines.pop(),this.lineCount=this.lines.length,this.computedHeight=this.lineCount*this.size*this.lineHeight,this.computedWidth=Math.max(...this.lines.map((e=>e.width)))}}class a extends THREE.BufferGeometry{charGeometry;layout;computedWidth;computedHeight;lineCount;recordedAttributes;constructor({widthSegments:e=1,heightSegments:i=1,...n}={}){super(),this.layout=new h(n),this.charGeometry=new THREE.PlaneGeometry(1,1,e,i),this.recordedAttributes=Object.keys(t).reduce(((e,i)=>{const s=t[i].default||n[i];return e[i]=s,e}),{}),this.computeGeometry()}get text(){return this.layout.text}set text(e){this.layout.text=e}computeGeometry(){const e=this.layout.text.replace(/[ \n]/g,""),i=this.recordedAttributes,n=e.length,s=this.charGeometry.attributes.position.count,r=this.charGeometry.index.count,o=new Uint32Array(n*r);Object.keys(i).forEach((e=>{if(i[e]){const i=t[e].size;this.setAttribute(e,new THREE.BufferAttribute(new Float32Array(n*s*i),i))}}));for(let e=0;e<n;e++)if(this.charGeometry){const t=new Array(s);for(let i=0,n=t.length;i<n;i++)t[i]=e;this.attributes.id.array.set(t,e*s);const i=new Array(r);for(let t=0,n=i.length;t<n;t++)i[t]=e*s+this.charGeometry.index.array[t];o.set(i,e*r)}else this.attributes.id.array.set([e,e,e,e],4*e),o.set([4*e,4*e+2,4*e+1,4*e+1,4*e+2,4*e+3],6*e);this.setIndex(Array.from(o)),this.computeLayout(),this.populateBuffers()}computeLayout(){this.layout.compute()}populateBuffers(){const e=this.layout,t=this.charGeometry.attributes.position.count;this.charGeometry.index.count;const i=this.charGeometry.attributes.uv.array,n=(e,n,s,r,o,h)=>{const a=this.attributes[e].array;for(let e=0,d=2*t;e<d;e+=2)a[h+e]=i[e]*(r-n)+n,a[h+e+1]=i[e+1]*(o-s)+s},s=(e,n,s,r,o,h,a=0)=>{const d=this.attributes[e].array;for(let e=0,l=0,u=3*t;e<u;e+=3,l+=2)d[h+e]=i[l]*(r-n)+n,d[h+e+1]=i[l+1]*(o-s)+s,d[h+e+2]=a},o=e.font.common.scaleW,h=e.font.common.scaleH,a=e.computedHeight,d=e.computedWidth,l="auto"!==e.width?e.width:d,u="auto"!==e.height?e.height:a;let c,f,m=-(e.lineHeight*e.size-e.size)/2,g=0,x=0,p=0;const S={lineIndex:0,charIndex:0,wordIndex:0,lineCharIndex:0,lineWordIndex:0,lineWordCount:0,lineCharCount:0};for("center"===e.alignY?p=e.computedHeight/2:"bottom"===e.alignY&&(p=e.computedHeight),m+=p,S.lineIndex=0;S.lineIndex<e.lines.length;S.lineIndex++){const i=e.lines[S.lineIndex];S.lineCharIndex=S.lineWordIndex=S.lineWordCount=0,S.lineCharCount=i.chars.length,this.recordedAttributes.lineWordCount&&(S.lineWordCount=i.chars.reduce(((e,t,n)=>{const s=r.test(t.definition.char),o=0!==n&&n!==i.chars.length-1;return s&&o&&e++,e}),1));for(let a=0;a<i.chars.length;a++){const d=i.chars[a].definition,y=x*t;if(r.test(d.char)){S.wordIndex++,S.lineWordIndex++;continue}const _=d.width*e.textScale,b=d.height*e.textScale;g=i.chars[a].x,g+=d.xoffset*e.textScale,m-=d.yoffset*e.textScale,f=g,c=m-p,"center"===e.alignX?(f=.5*l-.5*i.width+g,g-=.5*i.width):"right"===e.alignX&&(f=l-i.width+g,g-=i.width);const w=d.x/o,T=d.width/o,v=1-d.y/h,E=d.height/h;s("position",g,m-b,g+_,m,3*y),n("charUv",w,v-E,w+T,v,2*y),this.recordedAttributes.uv&&n("uv",f/l,1-(c-b)/-u,(f+_)/l,1-c/-u,2*y),this.recordedAttributes.charPosition&&s("charPosition",g+_/2,m-b/2,g+_/2,m-b/2,3*y),this.recordedAttributes.normal&&s("normal",0,0,0,0,3*y,1),this.recordedAttributes.charSize&&n("charSize",_,b,_,b,2*y);for(let e in S)if(this.recordedAttributes[e])for(let i=0;i<t;i++)this.attributes[e].array[4*y]=S[e];m+=d.yoffset*e.textScale,x++,S.charIndex++,S.lineCharIndex++}S.wordIndex++,m-=e.size*e.lineHeight}this.computeBoundingBox()}computeBoundingBox(){const{alignX:e,alignY:t,computedWidth:i,computedHeight:n}=this.layout;this.boundingBox||(this.boundingBox=new THREE.Box3),this.boundingBox.min.setScalar(0),this.boundingBox.max.setScalar(0),"center"===e&&(this.boundingBox.min.x=-i/2,this.boundingBox.max.x=i/2),"center"===t&&(this.boundingBox.min.y=-n/2,this.boundingBox.max.y=n/2),"left"===e&&(this.boundingBox.max.x=i),"right"===e&&(this.boundingBox.min.x=-i),"bottom"===t&&(this.boundingBox.max.y=n),"top"===t&&(this.boundingBox.min.y=-n),(isNaN(i)||isNaN(n))&&console.error("THREE.TextGeometry.computeBoundingBox(): Computed min/max have NaN values. The layout may be corrupted.",this)}resize(e,t="auto"){this.layout.width=e,this.layout.height=t,this.computeGeometry()}updateText(e){this.layout.text=e,this.computeGeometry()}}function d(e,t,i){const n=`_${t}`,s=`u${t[0].toUpperCase()+t.substring(1)}`;e[n]=i,Object.defineProperty(e,t,{get:()=>e[n],set(t){e[n]=t,e.userData.shader&&(e.userData.shader.uniforms[s].value=t)}})}THREE.ShaderChunk.msdf_alphatest_fragment="#define GLSLIFY 1\n#define SQRT2DIV2 0.7071067811865476\n#ifdef USE_MSDF_GEOMETRY\nvec3 msdfTexel=texture2D(uAtlas,vCharUv).rgb;float signedDist=max(min(msdfTexel.r,msdfTexel.g),min(max(msdfTexel.r,msdfTexel.g),msdfTexel.b))-0.5;float msdfD=fwidth(signedDist);\n#ifdef USE_THRESHOLD\nfloat msdfTest=smoothstep(uThreshold-SQRT2DIV2,uThreshold+SQRT2DIV2,signedDist);\n#else\nfloat msdfTest=smoothstep(-msdfD,msdfD,signedDist);\n#endif\nif(msdfTest<0.01)discard;float signedDistOutset=signedDist+uStrokeOuterWidth*0.5;float signedDistInset=signedDist-uStrokeInnerWidth*0.5;\n#ifdef USE_THRESHOLD\nfloat outerAlpha=smoothstep(uThreshold-SQRT2DIV2,uThreshold+SQRT2DIV2,signedDistOutset);float innerAlpha=1.0;\n#ifdef USE_STROKE\ninnerAlpha-=smoothstep(uThreshold-SQRT2DIV2,uThreshold+SQRT2DIV2,signedDistInset);\n#endif\n#else\nfloat outerAlpha=clamp(signedDistOutset/fwidth(signedDistOutset)+0.5,0.0,1.0);float innerAlpha=1.0;\n#ifdef USE_STROKE\ninnerAlpha-=clamp(signedDistInset/fwidth(signedDistInset)+0.5,0.0,1.0);\n#endif\n#endif\ndiffuseColor.a*=outerAlpha*innerAlpha;\n#endif\n",THREE.ShaderChunk.msdf_alphatest_pars_fragment="#define GLSLIFY 1\n#ifdef USE_MSDF_GEOMETRY\nvarying vec2 vCharUv;uniform sampler2D uAtlas;\n#ifdef USE_THRESHOLD\nuniform float uThreshold;\n#endif\n#ifdef USE_STROKE\nuniform float uStrokeOuterWidth;uniform float uStrokeInnerWidth;\n#else\nfloat uStrokeOuterWidth=0.0;float uStrokeInnerWidth=1.0;\n#endif\n#endif\n",THREE.ShaderChunk.msdf_char_uv_vertex="#define GLSLIFY 1\n#ifdef USE_MSDF_GEOMETRY\nvCharUv=charUv;\n#endif\n",THREE.ShaderChunk.msdf_char_uv_pars_vertex="#define GLSLIFY 1\n#ifdef USE_MSDF_GEOMETRY\nattribute vec2 charUv;varying vec2 vCharUv;\n#endif\n";let l=0;e.Font=i,e.TextGeometry=a,e.extendMSDFMaterial=function(e,{atlas:t,threshold:i,stroke:n,strokeInnerWidth:s=.5,strokeOuterWidth:r=0}={}){const o=e;l++,e.customProgramCacheKey=()=>String(l);const h={userCallback:null,msdfCallback:(s,r)=>{const a=s;!function(e){e.fragmentShader=e.fragmentShader.replace("#include <alphatest_pars_fragment>","#include <alphatest_pars_fragment>\n#include <msdf_alphatest_pars_fragment>"),e.fragmentShader=e.fragmentShader.replace("#include <alphatest_fragment>","#include <alphatest_fragment>\n#include <msdf_alphatest_fragment>"),e.vertexShader=e.vertexShader.replace("#include <uv_pars_vertex>","#include <uv_pars_vertex>\n#include <msdf_char_uv_pars_vertex>"),e.vertexShader=e.vertexShader.replace("#include <uv_vertex>","#include <uv_vertex>\n#include <msdf_char_uv_vertex>")}(s),a.defines||(a.defines={}),a.uniforms||(a.uniforms={});const d=void 0!==i,l=!!n;a.defines.USE_MSDF_GEOMETRY="",a.uniforms.uAtlas={value:t},d&&(a.defines.USE_THRESHOLD="",a.uniforms.uThreshold={value:o.threshold||0}),l&&(a.defines.USE_STROKE="",a.uniforms.uStrokeOuterWidth={value:o.strokeOuterWidth},a.uniforms.uStrokeInnerWidth={value:o.strokeInnerWidth}),e.userData.shader=s,h.userCallback&&h.userCallback(s,r)}};return Object.defineProperty(o,"isStroke",{get:()=>n,set:()=>{console.warn('Cannot set property "isStroke"')}}),d(o,"strokeOuterWidth",r),d(o,"strokeInnerWidth",s),d(o,"threshold",i),Object.defineProperty(e,"onBeforeCompile",{get:()=>h.msdfCallback,set(e){h.userCallback=e}}),e},Object.defineProperty(e,"__esModule",{value:!0})}));
